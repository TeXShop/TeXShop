From 7743c7d49d983772865eab2de1f249bd7c63dcd9 Mon Sep 17 00:00:00 2001
From: Martin <martin@hairer.org>
Date: Sun, 31 Jul 2016 16:08:51 +0100
Subject: [PATCH] Squashed version

---
 Sources/MyPDFKitView.h    |  3 ++-
 Sources/MyPDFKitView.m    | 20 +++++---------------
 Sources/MyPDFView.m       |  1 +
 Sources/TSDocument.h      |  1 -
 Sources/TSDocument.m      |  2 ++
 Sources/TSLogWindow.h     |  2 +-
 Sources/TSPreviewWindow.h |  2 --
 7 files changed, 11 insertions(+), 20 deletions(-)

diff --git a/Sources/MyPDFKitView.h b/Sources/MyPDFKitView.h
index 86106ef..e443fff 100644
--- a/Sources/MyPDFKitView.h
+++ b/Sources/MyPDFKitView.h
@@ -113,7 +113,7 @@
 
 @property (retain) PDFOutline						*outline;
 @property (retain) NSMutableArray					*searchResults;
-@property (retain) NSWindow                         *myPDFWindow;
+@property (weak) NSWindow                         *myPDFWindow;
 @property (retain) NSTimer							*selRectTimer;
 @property (retain) id								imageTypeView;
 @property (retain) id								imageTypePopup;
@@ -225,6 +225,7 @@
 - (NSInteger)index;
 - (NSImage *)imageFromSelection;
 - (NSDrawer *)drawer;
+- (void) breakConnections;
 // - (void) setOverView:(OverView *)theOveView;
 // - (OverView *)overView;
 // - (BOOL)resignFirstResponder;
diff --git a/Sources/MyPDFKitView.m b/Sources/MyPDFKitView.m
index b1e5ed7..a78e432 100644
--- a/Sources/MyPDFKitView.m
+++ b/Sources/MyPDFKitView.m
@@ -56,26 +56,16 @@
 
 @implementation MyPDFKitView : PDFView
 
-- (void) dealloc
+- (void) breakConnections
 {
-	
+    // Breaks retain cycles to prevent memory leaks.
     [self cleanupMarquee: YES];
+    [self.myPDFWindow setDelegate:nil];
+    [[self document] setDelegate:nil];
+    [self setDocument:nil];
 	
 	// No more notifications.
 	[[NSNotificationCenter defaultCenter] removeObserver: self];
-
-	// Clean up.
-/*
-	if (self.searchResults != NULL) {
-		[self.searchResults removeAllObjects];
-		[self.searchResults release];
-		self.searchResults = NULL;
-	}
-	[self.sourceFiles release];
-
-
-	[super dealloc];
- */
 }
 
 - (id)init
diff --git a/Sources/MyPDFView.m b/Sources/MyPDFView.m
index 0da0678..9af9838 100644
--- a/Sources/MyPDFView.m
+++ b/Sources/MyPDFView.m
@@ -3508,6 +3508,7 @@ failed. If you change the code below, be sure to test carefully!
 {
 	if (centerPage || !(resizeOption == PDF_ACTUAL_SIZE || resizeOption == PDF_FIT_TO_NONE))
 		[self fitToSize];
+    [super viewDidEndLiveResize];
 }
 
 
diff --git a/Sources/TSDocument.h b/Sources/TSDocument.h
index 6e22964..e18a1b8 100644
--- a/Sources/TSDocument.h
+++ b/Sources/TSDocument.h
@@ -113,7 +113,6 @@ enum RootCommand
 
 	IBOutlet MyPDFKitView		*myPDFKitView;
 	IBOutlet TSPreviewWindow	*pdfKitWindow;
-    IBOutlet TSPreviewWindow    *pdfKitWindow1;
 	IBOutlet MyPDFKitView		*myPDFKitView2;
 
 	IBOutlet NSWindow			*outputWindow;		/*" window displaying the output of the running TeX process "*/
diff --git a/Sources/TSDocument.m b/Sources/TSDocument.m
index 4ed6525..46c2e1c 100644
--- a/Sources/TSDocument.m
+++ b/Sources/TSDocument.m
@@ -1959,6 +1959,8 @@ in other code when an external editor is being used. */
 
 - (void)close
 {
+    [myPDFKitView breakConnections];
+    [myPDFKitView2 breakConnections];
 	
 	[self.tagTimer invalidate];
 //	[self.tagTimer release];
diff --git a/Sources/TSLogWindow.h b/Sources/TSLogWindow.h
index e7bd079..0d472bf 100644
--- a/Sources/TSLogWindow.h
+++ b/Sources/TSLogWindow.h
@@ -31,7 +31,7 @@
 //	TSDocument	*myDocument;
 }
 
-@property (retain) TSDocument	*myDocument;
+@property (weak) TSDocument	*myDocument;
 
 - (void) displayLog: sender;
 - (void) displayConsole: sender;
diff --git a/Sources/TSPreviewWindow.h b/Sources/TSPreviewWindow.h
index 95067db..8ed395e 100644
--- a/Sources/TSPreviewWindow.h
+++ b/Sources/TSPreviewWindow.h
@@ -106,7 +106,6 @@
 - (void) splitWindow: (id)sender; // so menu item can split both source and preview window
 - (void)fixAfterRotation: (BOOL) clockwise;
 // - (BOOL) validateMenuItem:(NSMenuItem *)anItem;
-- (void) setActiveView:(PDFView *)theView;
 - (void) changeMouseMode: sender;
 - (void) doStepper: sender;
 - (void) changeScale: sender;
@@ -115,7 +114,6 @@
 - (IBAction) takeDestinationFromOutline: (id) sender;
 - (IBAction) convertTiff:(id)sender;
 
-- (PDFView *)activeView;
 - (BOOL)windowIsSplit;
 
 @end
-- 
2.8.1

