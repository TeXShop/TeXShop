#!/bin/sh

# hard coded for the time being until we can get it form the App wrapper
VERSION=1.13c
CONTENTS="$1/Contents"
DMG=TeXShop-"${VERSION}".dmg

if [ -d "${CONTENTS}" ]
then
	INFOPLIST="${CONTENTS}/Info.plist"
	if grep "${VERSION}" "${INFOPLIST}" >/dev/null 2>&1
	then
		
		echo "Creating ${DMG} for \"$1\"..."
	else
		echo "Wrong version in \"$1\", should be ${VERSION}"
		exit 1
	fi
else
	echo "Cannot find application \"$1\""
	exit 2
fi

VOLNAME="TeXShop-${VERSION}-Volume"
rm -f "${DMG}" "${DMG}".gz
hdiutil create -megabytes 4 "${DMG}" -layout NONE
TSDisk=`hdid -nomount "${DMG}"|sed 's/ .*//'`
echo "Disk: ${TSDisk}"
newfs_hfs -v "${VOLNAME}" "${TSDisk}"
hdiutil eject "${TSDisk}"
echo Step
HDID=`hdid "${DMG}"`
# Warning: hidden behaviour
# Both patterns below contain a space and a tab. Do not edit with an editor
# that translates tab to space or space to tab
TSDisk=`echo -n "${HDID}"|sed 's/[ 	].*//'`
TSVolume=`echo -n "${HDID}"|sed 's/^[^ 	]*[ 	]*//'`

echo "Disk: ${TSDisk} Vol: ${TSVolume}"

if [ ! -d "${TSVolume}" ]
then
	echo "Cannot locate teTeX volume. Baling out..."
	exit 1
else
	cp -pr "$1" "${TSVolume}"
fi

hdiutil eject "${TSDisk}"
gzip -9 "${DMG}"

exit 0
